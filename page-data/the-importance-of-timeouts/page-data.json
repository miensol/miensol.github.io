{"componentChunkName":"component---src-templates-post-template-tsx","path":"/the-importance-of-timeouts/","result":{"data":{"markdownRemark":{"id":"8a516c6b-14c9-5127-948d-73b99ba03753","html":"<p><a href=\"https://en.wikipedia.org/wiki/Timeout_(computing)\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Timeouts</a> are not an exciting thing to talk about. They do not add immediately perceivable value. They are difficult to <del>guess</del> get right and force one to <a href=\"https://en.wikipedia.org/wiki/Byzantine_fault_tolerance#Byzantine_Generals.27_Problem\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">consider problems that are hard to solve</a>. In fact, in my experience, the timeout is only ever considered when our software stops working or is about to. That is an enormous shame since, in my opinion, carefully applied timeouts can vastly improve software resiliency. </p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 640px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5a62ff5b481f38c5ffe98957ddf1fbf4/c08c5/man-clock.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 73.33333333333334%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAPABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAABQAEBv/EABUBAQEAAAAAAAAAAAAAAAAAAAIB/9oADAMBAAIQAxAAAAEZDOibz83I/wD/xAAaEAACAwEBAAAAAAAAAAAAAAABAgASEwME/9oACAEBAAEFAkKzMViHIjmHLeU2/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAHBAAAgICAwAAAAAAAAAAAAAAAREAAhAhIkGh/9oACAEBAAY/AtuN1tgGwYPUBrxfs0RP/8QAHBABAAICAwEAAAAAAAAAAAAAAQARIXExUWHR/9oACAEBAAE/IbPFqDMdGmJTBIjXCBGvHwxqsHuJ/9oADAMBAAIAAwAAABDHL//EABcRAAMBAAAAAAAAAAAAAAAAAAABESH/2gAIAQMBAT8QSU0p/8QAFhEBAQEAAAAAAAAAAAAAAAAAAREA/9oACAECAQE/EFbNN//EABwQAQACAwADAAAAAAAAAAAAAAEAESExYUFxkf/aAAgBAQABPxASOVq/ZR3RLA6xcRBEezXfAXy+MqlTQk92efZiKDNsck//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/5a62ff5b481f38c5ffe98957ddf1fbf4/8ac56/man-clock.webp 240w,\n/static/5a62ff5b481f38c5ffe98957ddf1fbf4/d3be9/man-clock.webp 480w,\n/static/5a62ff5b481f38c5ffe98957ddf1fbf4/0ba47/man-clock.webp 640w\"\n          sizes=\"(max-width: 640px) 100vw, 640px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/5a62ff5b481f38c5ffe98957ddf1fbf4/09b79/man-clock.jpg 240w,\n/static/5a62ff5b481f38c5ffe98957ddf1fbf4/7cc5e/man-clock.jpg 480w,\n/static/5a62ff5b481f38c5ffe98957ddf1fbf4/c08c5/man-clock.jpg 640w\"\n          sizes=\"(max-width: 640px) 100vw, 640px\"\n          type=\"image/jpeg\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/5a62ff5b481f38c5ffe98957ddf1fbf4/c08c5/man-clock.jpg\"\n          alt=\"Man with a wrist clock\"\n          title=\"Man with a wrist clock\"\n          loading=\"lazy\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        />\n      </picture>\n  </a>\n    </span></p>\n<h2 id=\"an-example-application\" style=\"position:relative;\"><a href=\"#an-example-application\" aria-label=\"an example application permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>An example application</h2>\n<p>Let us consider a simplistic example of a Spring Boot application generated using <a href=\"https://start.spring.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Spring Initializr</a>. The application will only expose <a href=\"https://spring.io/guides/gs/actuator-service/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">actuator</a> API which by default define a health check endpoint. Our example will also have a mail module configured. </p>\n<p>The dependencies section of <code class=\"language-text\">build.gradle</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"groovy\"><pre class=\"language-groovy\"><code class=\"language-groovy\">dependencies <span class=\"token punctuation\">{</span>\n\t<span class=\"token function\">compile</span><span class=\"token punctuation\">(</span><span class=\"token string\">'org.springframework.boot:spring-boot-starter-actuator'</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token function\">compile</span><span class=\"token punctuation\">(</span><span class=\"token string\">'org.springframework.boot:spring-boot-starter-mail'</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token function\">compile</span><span class=\"token punctuation\">(</span><span class=\"token string\">'org.springframework.boot:spring-boot-starter-web'</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token function\">compile</span><span class=\"token punctuation\">(</span><span class=\"token string gstring\">\"org.jetbrains.kotlin:kotlin-stdlib-jre8:<span class=\"token expression\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span>kotlinVersion<span class=\"token punctuation\">}</span></span>\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token function\">compile</span><span class=\"token punctuation\">(</span><span class=\"token string gstring\">\"org.jetbrains.kotlin:kotlin-reflect:<span class=\"token expression\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span>kotlinVersion<span class=\"token punctuation\">}</span></span>\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>A typical health check endpoint verifies that application integration points work correctly. If the service talks to database then a connection is established and verified. A free disk space is checked. If the service sends emails through SMTP then a connection to a server is established.</p>\n<p>The health checks are auto discovered and enabled when you include Spring Boot Actuator. By default, <code class=\"language-text\">/health</code> path is used for the endpoint. The SMTP server host, port and credentials obviously need to be configured. At minimum host entry is required e.g. <code class=\"language-text\">spring.mail.host=localhost</code>. <em>For the debugging purpose one can disable actuator security with <code class=\"language-text\">management.security.enabled=false</code> to verify what health checks are performed by actuator.</em></p>\n<p>A last part of our example is the trivial application code:</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token annotation builtin\">@SpringBootApplication</span>\n<span class=\"token keyword\">class</span> Application <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">companion</span> <span class=\"token keyword\">object</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token annotation builtin\">@JvmStatic</span>\n        <span class=\"token keyword\">fun</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>args<span class=\"token operator\">:</span> Array<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            SpringApplication<span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span>Application<span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span>java<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>args<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>When you request <code class=\"language-text\">/health</code> the API will return response similar to:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">HTTP/1.1 200 \nContent-Type: application/vnd.spring-boot.actuator.v1+json;charset=UTF-8\nDate: Mon, 23 Oct 2017 08:08:32 GMT\nTransfer-Encoding: chunked\nX-Application-Context: application\n\n{\n    &quot;diskSpace&quot;: {\n        &quot;free&quot;: 105755779072,\n        &quot;status&quot;: &quot;UP&quot;,\n        &quot;threshold&quot;: 10485760,\n        &quot;total&quot;: 499046809600\n    },\n    &quot;mail&quot;: {\n        &quot;location&quot;: &quot;localhost:-1&quot;,\n        &quot;status&quot;: &quot;UP&quot;\n    },\n    &quot;status&quot;: &quot;UP&quot;\n}</code></pre></div>\n<p>An application health API, like the one in our example, is often hooked into external monitoring software. The monitor asks the target application about its health in regular intervals e.g. every 5 seconds. </p>\n<h2 id=\"shooting-yourself-in-the-foot\" style=\"position:relative;\"><a href=\"#shooting-yourself-in-the-foot\" aria-label=\"shooting yourself in the foot permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Shooting yourself in the foot</h2>\n<p>The above example has an issue that can kill production server. More importantly, other metrics that are usually monitored e.g. CPU and memory usage will not warn about upcoming, dreadful service stall. The application will also not suffer from an enormous number of requests or emails being sent.</p>\n<p>Imagine that the health endpoint is checked every 5 seconds and that there is <strong>intermittent</strong> issue with the SMPT server. The health endpoint will <strong>rightfully</strong> try to connect to the SMTP server and from time to time respond with error. From my experience, when a health check is introduced it typically takes a while to tweak the monitor thresholds so that we get rid of false alarms. It is thus very easy to ignore intermittent errors when we think they are caused by too sensitive thresholds. However, the ignored errors can after a while cause our server to stop responding to <strong>any request</strong>. </p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 640px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9cb8a4fa7b7c9ccb14f866e9d15d8913/c08c5/error.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAEDBAX/xAAWAQEBAQAAAAAAAAAAAAAAAAADAQL/2gAMAwEAAhADEAAAAddSVjqGDv8A/8QAGhAAAgIDAAAAAAAAAAAAAAAAAQIAERIyQf/aAAgBAQABBQIijVxUbA6dn//EABURAQEAAAAAAAAAAAAAAAAAAAEQ/9oACAEDAQE/ASf/xAAWEQADAAAAAAAAAAAAAAAAAAADEDH/2gAIAQIBAT8BJF//xAAZEAABBQAAAAAAAAAAAAAAAAAhAhARIDH/2gAIAQEABj8CZJkbT//EABwQAQEBAAIDAQAAAAAAAAAAAAERACFBMVFhgf/aAAgBAQABPyGBD985rPlr1kpzoUduUvvVrlxwQUPQ7//aAAwDAQACAAMAAAAQhB//xAAYEQACAwAAAAAAAAAAAAAAAAAAASFxsf/aAAgBAwEBPxBZLw//xAAaEQEAAQUAAAAAAAAAAAAAAAABADFBUYHh/9oACAECAQE/EEgM1itlN8n/xAAZEAEBAQEBAQAAAAAAAAAAAAABEQAhMZH/2gAIAQEAAT8QA4F7BX13j0RJ6/WFZTKSHUnMwl4COYcL7GXWYgQQAb//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/9cb8a4fa7b7c9ccb14f866e9d15d8913/8ac56/error.webp 240w,\n/static/9cb8a4fa7b7c9ccb14f866e9d15d8913/d3be9/error.webp 480w,\n/static/9cb8a4fa7b7c9ccb14f866e9d15d8913/0ba47/error.webp 640w\"\n          sizes=\"(max-width: 640px) 100vw, 640px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/9cb8a4fa7b7c9ccb14f866e9d15d8913/09b79/error.jpg 240w,\n/static/9cb8a4fa7b7c9ccb14f866e9d15d8913/7cc5e/error.jpg 480w,\n/static/9cb8a4fa7b7c9ccb14f866e9d15d8913/c08c5/error.jpg 640w\"\n          sizes=\"(max-width: 640px) 100vw, 640px\"\n          type=\"image/jpeg\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/9cb8a4fa7b7c9ccb14f866e9d15d8913/c08c5/error.jpg\"\n          alt=\"Man with a wrist clock\"\n          title=\"Man with a wrist clock\"\n          loading=\"lazy\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        />\n      </picture>\n  </a>\n    </span></p>\n<p>Why this can happen you ask and I answer. <strong>There is no timeout configured!</strong></p>\n<p>The mail server health check uses <a href=\"https://docs.oracle.com/javaee/6/api/javax/mail/Service.html#connect(java.lang.String,%20java.lang.String)\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">javax.mail.Service.connect</code></a> under the hood. For a variety of reasons an attempt to establish a TCP connection can take arbitrary longer than usual. Unfortunately <strong>the default</strong> timeouts used by the <code class=\"language-text\">javax.mail.*</code> <a href=\"https://javaee.github.io/javamail/docs/api/com/sun/mail/smtp/package-summary.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">are <strong>infinite</strong></a>. A thread that waits for the connection to be established cannot serve other requests even though it barely uses any CPU. The default maximum thread pool size used by embedded Tomcat in Spring Boot application is 200. Assuming that the blocked connection attempt happens twice an hour our application will stop working after 4 days.</p>\n<h2 id=\"never-use-infinite-timeouts\" style=\"position:relative;\"><a href=\"#never-use-infinite-timeouts\" aria-label=\"never use infinite timeouts permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Never use infinite timeouts</h2>\n<p>As you can see it is very easy to miss a need for a timeout to be configured. To be fair the <a href=\"https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-email.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Spring Boot documentation</a> states clearly:</p>\n<blockquote>\n<p>In particular, certain default timeout values are infinite and you may want to change that to avoid having a thread blocked by an unresponsive mail server:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">spring.mail.properties.mail.smtp.connectiontimeout=5000\nspring.mail.properties.mail.smtp.timeout=3000\nspring.mail.properties.mail.smtp.writetimeout=5000</code></pre></div>\n</blockquote>\n<p>In my option any library or framework should either force the programmer to configure the timeout or have some <strong>sensible default</strong>. Unfortunately this is not always possible to introduce them later on without breaking changes hence we should <strong>check</strong> what are the timeouts used when calling any <strong>external service</strong>.</p>\n<h2 id=\"timeouts-needed-everywhere\" style=\"position:relative;\"><a href=\"#timeouts-needed-everywhere\" aria-label=\"timeouts needed everywhere permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Timeouts needed everywhere</h2>\n<p>Imagine a controller action method that inserts a single row into a database. Let us further assume that the endpoint is called 50 times per second and it typically takes 100ms to complete. Things work well until we encounter an intermittent sloppiness of the database and now the insert takes 2 seconds to complete. The clients calling the API do not slow down. More request threads are blocked and <strong>more database connections</strong> are taken out of the pool. Soon as all database connections are in use and all other API endpoints start to fail. This is an example of cascading failure i.e. a problem in one component propagating to others. It is easier to avoid such issues when there is a timeout configured on the controller action and the interaction with the database. </p>\n<p>Every API endpoint <strong>should have a timeout configured</strong> if we want our services to be resilient. Unfortunately this rule is easy to neglect. Moreover, some frameworks do not even expose such ability. Even in the immensely popular Spring Mvc I could not find a way to set such timeout other than using an <a href=\"https://spring.io/guides/gs/async-method/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">async method</a>. Fortunately there are libraries e.g. <a href=\"https://github.com/Netflix/Hystrix\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Hystrix</a> that tackle that problem and can be integrated easily.</p>\n<p>Just to recap here is a short and incomplete list of cases where a timeout should be configured:</p>\n<ul>\n<li>a controller action </li>\n<li>a database query, statement</li>\n<li>a database pool interaction</li>\n<li>a thread pool interaction</li>\n<li>an API client e.g. HTTP, SOAP, SMTP</li>\n</ul>\n<p>I will describe how to deal with the cases in the following posts.</p>","fields":{"slug":"/the-importance-of-timeouts/","tagSlugs":["/tag/server/","/tag/request/","/tag/timeout/","/tag/query/","/tag/resiliency/","/tag/spring-boot/"]},"excerpt":"Timeouts are not an exciting thing to talk about. They do not add immediately perceivable value. They are difficult to guess get right and force one to consider problems that are hard to solve. In fact, in my experience, the timeout is only ever considered when our software stops working or is about to. That is anâ€¦","frontmatter":{"date":"2017-10-23T22:14:00.000Z","description":null,"tags":["server","request","timeout","query","resiliency","spring boot"],"title":"The importance of timeouts","socialImage":null}}},"pageContext":{"slug":"/the-importance-of-timeouts/"}}}