{"componentChunkName":"component---src-templates-post-template-tsx","path":"/in-memory-database-tests-with-querydsl/","result":{"data":{"markdownRemark":{"id":"e1cc9af0-8b92-54cd-a64e-76607e2060d0","html":"<p>Writing tests is an important skill of a software engineer. I used to write lots of very focused, narrow unit tests. However, I often found such tests to hinder refactoring and barely help in catching regressions. Whether such issues were caused by my poor design choices or are intrinsic to unit tests is not the focus of this post. However, the fact is that nowadays I tend to write more coarse-grained, integration style tests. There is one downside to such approach: speed. For instance, using Hibernate with a full fledged database is relatively slow compared to using a fake repository implementation. Today I write about abstracting the database access using <a href=\"http://www.querydsl.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Querydsl</a> in a way that aids testing.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 640px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ccacd62b2cb75489034f561354f95cc2/c08c5/test.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 72.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAOABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAQBAgP/xAAVAQEBAAAAAAAAAAAAAAAAAAACA//aAAwDAQACEAMQAAABjVMm2igKf//EABoQAQACAwEAAAAAAAAAAAAAAAEAAgMREiL/2gAIAQEAAQUCq2YCzHbdfQvbK49H/8QAFhEBAQEAAAAAAAAAAAAAAAAAAQAR/9oACAEDAQE/AXWFv//EABYRAQEBAAAAAAAAAAAAAAAAAAEAEv/aAAgBAgEBPwEzJf/EABwQAAEDBQAAAAAAAAAAAAAAAAABETECEBIhIv/aAAgBAQAGPwLlBsraaBlrJP/EABsQAAMAAwEBAAAAAAAAAAAAAAABESExQVFx/9oACAEBAAE/IbsIh9UPxcEbHslrJQ7qviO0zk//2gAMAwEAAgADAAAAEL/P/8QAFhEBAQEAAAAAAAAAAAAAAAAAAQAR/9oACAEDAQE/ENSDCAv/xAAWEQEBAQAAAAAAAAAAAAAAAAABACH/2gAIAQIBAT8QANIVUv/EAB0QAQADAAEFAAAAAAAAAAAAAAEAESExQZGxwdH/2gAIAQEAAT8QToOW0zvF6x119IiVEYrOkMlrkcfEVsC6FEGldXBPk//Z'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/ccacd62b2cb75489034f561354f95cc2/8ac56/test.webp 240w,\n/static/ccacd62b2cb75489034f561354f95cc2/d3be9/test.webp 480w,\n/static/ccacd62b2cb75489034f561354f95cc2/0ba47/test.webp 640w\"\n          sizes=\"(max-width: 640px) 100vw, 640px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/ccacd62b2cb75489034f561354f95cc2/09b79/test.jpg 240w,\n/static/ccacd62b2cb75489034f561354f95cc2/7cc5e/test.jpg 480w,\n/static/ccacd62b2cb75489034f561354f95cc2/c08c5/test.jpg 640w\"\n          sizes=\"(max-width: 640px) 100vw, 640px\"\n          type=\"image/jpeg\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/ccacd62b2cb75489034f561354f95cc2/c08c5/test.jpg\"\n          alt=\"test\"\n          title=\"test\"\n          loading=\"lazy\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        />\n      </picture>\n  </a>\n    </span></p>\n<h2 id=\"querydsl-is-awesome\" style=\"position:relative;\"><a href=\"#querydsl-is-awesome\" aria-label=\"querydsl is awesome permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Querydsl is awesome</h2>\n<p><a href=\"http://www.querydsl.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Querydsl</a> is a set of libraries that, as the name implies, provides strongly typed Domain Specific Language to execute queries. <a href=\"http://www.querydsl.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Querydsl</a> supports many data access technologies e.g. JDBC, Hibernate, JDO.\nThe following example in Kotlin illustrates how a DSL generated based on entity class can be used to find some entities through JPA interface:</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">val</span> queryFactory<span class=\"token operator\">:</span> JPAQueryFactory <span class=\"token operator\">=</span> <span class=\"token operator\">..</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">val</span> userEmailToSearch <span class=\"token operator\">=</span> <span class=\"token string\">\"alamakota@gmail.com\"</span>\n<span class=\"token keyword\">val</span> user <span class=\"token operator\">=</span> queryFactory<span class=\"token punctuation\">.</span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>QUser<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">where</span><span class=\"token punctuation\">(</span>QUser<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">.</span>email<span class=\"token punctuation\">.</span><span class=\"token function\">eq</span><span class=\"token punctuation\">(</span>userEmailToSearch<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span>QUser<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">fetchOne</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>One important option available is the <a href=\"https://github.com/querydsl/querydsl/tree/master/querydsl-collections\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Collections</a> module that offers an integration to POJO collections and beans. The following example in Kotlin shows how a list of users can be queried:</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">val</span> users <span class=\"token operator\">=</span> <span class=\"token function\">listOf</span><span class=\"token punctuation\">(</span>userAlan<span class=\"token punctuation\">,</span> userBob<span class=\"token punctuation\">,</span> userAlice<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">val</span> user <span class=\"token operator\">=</span> CollQuery<span class=\"token operator\">&lt;</span>Nothing<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>QUser<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">,</span> users<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">where</span><span class=\"token punctuation\">(</span>QUser<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">.</span>email<span class=\"token punctuation\">.</span><span class=\"token function\">eq</span><span class=\"token punctuation\">(</span>userEmailToSearch<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span>QUser<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">fetchOne</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h2 id=\"abstract-the-complex-away\" style=\"position:relative;\"><a href=\"#abstract-the-complex-away\" aria-label=\"abstract the complex away permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Abstract the complex away</h2>\n<p>The above examples look similar thanks to common interface provided by Querydsl. However, while the default DSL is very capable I found it a bit verbose in the most common cases. For that matter let us define a bit simpler interface that will allow for finding entities given some criteria</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">interface</span> EntityQueries <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token operator\">&lt;</span>TQEntity <span class=\"token operator\">:</span> EntityPath<span class=\"token operator\">&lt;</span>TEntity<span class=\"token operator\">></span><span class=\"token punctuation\">,</span> TEntity <span class=\"token operator\">:</span> Any<span class=\"token operator\">></span> <span class=\"token function\">findFirst</span><span class=\"token punctuation\">(</span>\n        qEntity<span class=\"token operator\">:</span> TQEntity<span class=\"token punctuation\">,</span> \n        <span class=\"token keyword\">where</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>TQEntity<span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> Predicate<span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> \n        orderBy<span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>TQEntity<span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> OrderSpecifier<span class=\"token operator\">&lt;</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> TEntity<span class=\"token operator\">?</span> \n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">val</span> queries<span class=\"token operator\">:</span>EntityQueries <span class=\"token operator\">=</span> <span class=\"token operator\">..</span><span class=\"token operator\">..</span>\n\n<span class=\"token keyword\">val</span> ala <span class=\"token operator\">=</span> queries<span class=\"token punctuation\">.</span><span class=\"token function\">findFirst</span><span class=\"token punctuation\">(</span>QUser<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">,</span> <span class=\"token keyword\">where</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> it<span class=\"token punctuation\">.</span>email<span class=\"token punctuation\">.</span><span class=\"token function\">eq</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ala@gmail.com\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">val</span> latestUser <span class=\"token operator\">=</span> queries<span class=\"token punctuation\">.</span><span class=\"token function\">findFirst</span><span class=\"token punctuation\">(</span>QUser<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">,</span> orderBy <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> it<span class=\"token punctuation\">.</span>created<span class=\"token punctuation\">.</span><span class=\"token function\">desc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>The above interface allows us to express commonly used queries in a more succinct fashion.</p>\n<h2 id=\"define-production-implementation\" style=\"position:relative;\"><a href=\"#define-production-implementation\" aria-label=\"define production implementation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Define production implementation</h2>\n<p>With Querydsl it is easy enough to implement the <code class=\"language-text\">EntityQueries</code> interface. First the production implementation delegating to JPA for actual data access technology:</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> <span class=\"token function\">QueryDslDomainQueryFactory</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> queryFactory<span class=\"token operator\">:</span> JPAQueryFactory<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> EntityQueries <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token operator\">&lt;</span>TQEntity <span class=\"token operator\">:</span> EntityPath<span class=\"token operator\">&lt;</span>TEntity<span class=\"token operator\">></span><span class=\"token punctuation\">,</span> TEntity <span class=\"token operator\">:</span> Any<span class=\"token operator\">></span> <span class=\"token function\">findFirst</span><span class=\"token punctuation\">(</span>qEntity<span class=\"token operator\">:</span> TQEntity<span class=\"token punctuation\">,</span> <span class=\"token keyword\">where</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>TQEntity<span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> Predicate<span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> orderBy<span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>TQEntity<span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> OrderSpecifier<span class=\"token operator\">&lt;</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> TEntity<span class=\"token operator\">?</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> queryFactory<span class=\"token punctuation\">.</span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>qEntity<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">where</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">where</span><span class=\"token punctuation\">(</span>qEntity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">apply</span> <span class=\"token punctuation\">{</span> <span class=\"token function\">orderBy</span><span class=\"token punctuation\">(</span>qEntity<span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">let</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">orderBy</span><span class=\"token punctuation\">(</span>it<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>  <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span>qEntity<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">fetchFirst</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The above lets us use the <code class=\"language-text\">EntityQueries</code> interface instead of JPA in e.g. Spring controllers like so:</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token annotation builtin\">@RestController</span>\n<span class=\"token keyword\">class</span> <span class=\"token function\">UsersController</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> queries<span class=\"token operator\">:</span> EntityQueries<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation builtin\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/users\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">getByEmail</span><span class=\"token punctuation\">(</span><span class=\"token annotation builtin\">@RequestParam</span> email<span class=\"token operator\">:</span> String<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> queries<span class=\"token punctuation\">.</span><span class=\"token function\">findFirst</span><span class=\"token punctuation\">(</span>QUser<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">,</span> <span class=\"token keyword\">where</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> it<span class=\"token punctuation\">.</span>email<span class=\"token punctuation\">.</span><span class=\"token function\">eq</span><span class=\"token punctuation\">(</span>email<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>One of the Spring recommended ways to abstract the specifics of query technology is to use <a href=\"https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repositories.query-methods\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">repository interfaces</a> e.g:</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">interface</span> UserRepository <span class=\"token operator\">:</span> Repository<span class=\"token operator\">&lt;</span>User<span class=\"token punctuation\">,</span> Long<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">fun</span> <span class=\"token function\">findByEmail</span><span class=\"token punctuation\">(</span>String email<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> User<span class=\"token operator\">?</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Such interface would be <em>magically</em> implemented by Spring runtime and put in the application context. The approach may seem appealing at first since we do not have to implement the interface. There are however, multiple issues:</p>\n<ul>\n<li>an application context is required which in turn is slow to bootstrap</li>\n<li>there is no compile time checks</li>\n<li>the refactoring is harder without a special support from IDE</li>\n<li>the actual behavior is hard to figure out without a careful documentation lecture (what will happen if e.g. there are multiple users with the same email?)</li>\n</ul>\n<p>The <code class=\"language-text\">EntityQueries</code> invocation to find users by email is almost as readable as <code class=\"language-text\">findByEmail</code> but does not suffer from any of downsides listed above. Encapsulating more complex filtering logic can be done with a simple extension method or a more elaborate <a href=\"https://en.wikipedia.org/wiki/Specification_pattern\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Specification pattern</a>. </p>\n<h2 id=\"using-in-memory-database-in-tests\" style=\"position:relative;\"><a href=\"#using-in-memory-database-in-tests\" aria-label=\"using in memory database in tests permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Using in-memory database in tests</h2>\n<p>We can use Spring test helpers to ease writing tests involving an application context that lets us inject e.g. <code class=\"language-text\">UsersController</code> instance to invoke its methods. However, such tests are, comparatively, very slow to run and thus cause the feedback loop to be much slower. Fortunately the <code class=\"language-text\">EntityQueries</code> abstraction is very easy to implement using POJO in-memory collections.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> InMemoryEntityQueries <span class=\"token operator\">:</span> <span class=\"token function\">QueriesBase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> EntityQueries <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">val</span> entities <span class=\"token operator\">=</span> mutableMapOf<span class=\"token operator\">&lt;</span>Class<span class=\"token operator\">&lt;</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> MutableList<span class=\"token operator\">&lt;</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token operator\">&lt;</span>TQEntity <span class=\"token operator\">:</span> EntityPath<span class=\"token operator\">&lt;</span>TEntity<span class=\"token operator\">></span><span class=\"token punctuation\">,</span> TEntity <span class=\"token operator\">:</span> Any<span class=\"token operator\">></span> <span class=\"token function\">findFirst</span><span class=\"token punctuation\">(</span>qEntity<span class=\"token operator\">:</span> TQEntity<span class=\"token punctuation\">,</span> <span class=\"token keyword\">where</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>TQEntity<span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> Predicate<span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> orderBy<span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>TQEntity<span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> OrderSpecifier<span class=\"token operator\">&lt;</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> TEntity<span class=\"token operator\">?</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">val</span> entities <span class=\"token operator\">=</span> entities<span class=\"token punctuation\">.</span><span class=\"token function\">getOrPut</span><span class=\"token punctuation\">(</span>qEntity<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> mutableListOf<span class=\"token operator\">&lt;</span>TEntity<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> List<span class=\"token operator\">&lt;</span>TEntity<span class=\"token operator\">></span>\n        <span class=\"token keyword\">return</span> CollQuery<span class=\"token operator\">&lt;</span>Nothing<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>qEntity<span class=\"token punctuation\">,</span> entities<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">where</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">where</span><span class=\"token punctuation\">(</span>qEntity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">apply</span> <span class=\"token punctuation\">{</span> <span class=\"token function\">orderBy</span><span class=\"token punctuation\">(</span>qEntity<span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">let</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">orderBy</span><span class=\"token punctuation\">(</span>it<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span>qEntity<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">fetchFirst</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The above implementation looks almost exactly the same as the production one. We can of course try to extract the common code to make things more DRY. However, the most important observation is that we delegate to Querydsl implementation for the important filtering and ordering logic. This can increase our confidence that the fake implementation behaves the same as production one with only difference being the actual entity storage.</p>\n<p>Given the above implementation we can now easily replace the <code class=\"language-text\">UsersController</code> dependency and instantiate it as a regular POJO:</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> UsersControllerTests <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">val</span> db <span class=\"token operator\">=</span> <span class=\"token function\">InMemoryEntityQueries</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">val</span> controller <span class=\"token operator\">=</span> <span class=\"token function\">UsersController</span><span class=\"token punctuation\">(</span>db<span class=\"token punctuation\">)</span>\n\n    <span class=\"token annotation builtin\">@Test</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">canFindByEmail</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        db<span class=\"token punctuation\">.</span>entities<span class=\"token punctuation\">[</span>User<span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span>java<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span>  <span class=\"token function\">listOf</span><span class=\"token punctuation\">(</span><span class=\"token function\">User</span><span class=\"token punctuation\">(</span>email <span class=\"token operator\">=</span> <span class=\"token string\">\"ala@gmail.com\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">User</span><span class=\"token punctuation\">(</span>email <span class=\"token operator\">=</span> <span class=\"token string\">\"ola@gmail.com\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n        controller<span class=\"token punctuation\">.</span><span class=\"token function\">getByEmail</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ola@gmail.com\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>email<span class=\"token punctuation\">.</span><span class=\"token function\">shouldEqual</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ola@gmail.com\"</span><span class=\"token punctuation\">)</span>\n        controller<span class=\"token punctuation\">.</span><span class=\"token function\">getByEmail</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"peter@gmail.com\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">shouldEqual</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"notes-on-in-memory-implementation\" style=\"position:relative;\"><a href=\"#notes-on-in-memory-implementation\" aria-label=\"notes on in memory implementation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Notes on in-memory implementation</h2>\n<p>The <code class=\"language-text\">EntityQueries</code> interface above is obviously a simplified version. The most important missing piece is the ability to save entities. However, this is not a hard thing to implement given the in-memory implementation. We can, for instance, make use of the fact that all of our entities are marked JPA Persistence annotations to find a field marked with <code class=\"language-text\">@Id</code>, generate the id and assign it based on the contents of the <code class=\"language-text\">entities</code> variable. Another approach is to mark all entities with a dedicated interface e.g.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">interface</span> HasId<span class=\"token operator\">&lt;</span>TId<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> id<span class=\"token operator\">:</span> TId\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>An entity implementing <code class=\"language-text\">HasId</code> could be checked in the <code class=\"language-text\">save</code> method of the in-memory implementation and assigned with a unique identifier e.g.:</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">fun</span> <span class=\"token operator\">&lt;</span>TEntity<span class=\"token operator\">:</span> HasId<span class=\"token operator\">&lt;</span>Long<span class=\"token operator\">></span><span class=\"token operator\">></span> <span class=\"token function\">save</span><span class=\"token punctuation\">(</span>entity<span class=\"token operator\">:</span> TEntity<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">val</span> entities <span class=\"token operator\">=</span> entities<span class=\"token punctuation\">.</span><span class=\"token function\">getOrPut</span><span class=\"token punctuation\">(</span>entity<span class=\"token punctuation\">.</span>javaClass<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> mutableListOf<span class=\"token operator\">&lt;</span>TEntity<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> List<span class=\"token operator\">&lt;</span>TEntity<span class=\"token operator\">></span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>entity<span class=\"token punctuation\">.</span>id <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        entity<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>entities<span class=\"token punctuation\">.</span><span class=\"token function\">map</span> <span class=\"token punctuation\">{</span> it<span class=\"token punctuation\">.</span>id <span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span>\n    <span class=\"token punctuation\">}</span>\n    entities <span class=\"token operator\">+=</span> entity\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Following the above approach we can easily add missing operations e.g. to remove an entity and that in turn allows us to write even more tests that run fully in-memory. It is worth noting that using an in-memory database implementation works best for queries that fetch, save or update one or multiple instances. As soon as we need to use a features natural to a database technology e.g. joins in SQL, we are better of connecting to a real database. While Querydsl collections module supports both join and group operations the in-memory implementation is often not equivalent to the database one especially around <code class=\"language-text\">null</code> values handling.</p>","fields":{"slug":"/in-memory-database-tests-with-querydsl/","tagSlugs":["/tag/kotlin/","/tag/querydsl/","/tag/hibernate/","/tag/jpa/","/tag/database/"]},"excerpt":"Writing tests is an important skill of a software engineer. I used to write lots of very focused, narrow unit tests. However, I often found such tests to hinder refactoring and barely help in catching regressions. Whether such issues were caused by my poor design choices or are intrinsic to unit tests is not the focusâ€¦","frontmatter":{"date":"2018-02-12T22:14:00.000Z","description":null,"tags":["kotlin","querydsl","hibernate","jpa","database"],"title":"In-memory database tests with Querydsl","socialImage":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAOABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAQBAgP/xAAVAQEBAAAAAAAAAAAAAAAAAAACA//aAAwDAQACEAMQAAABjVMm2igKf//EABoQAQACAwEAAAAAAAAAAAAAAAEAAgMREiL/2gAIAQEAAQUCq2YCzHbdfQvbK49H/8QAFhEBAQEAAAAAAAAAAAAAAAAAAQAR/9oACAEDAQE/AXWFv//EABYRAQEBAAAAAAAAAAAAAAAAAAEAEv/aAAgBAgEBPwEzJf/EABwQAAEDBQAAAAAAAAAAAAAAAAABETECEBIhIv/aAAgBAQAGPwLlBsraaBlrJP/EABsQAAMAAwEBAAAAAAAAAAAAAAABESExQVFx/9oACAEBAAE/IbsIh9UPxcEbHslrJQ7qviO0zk//2gAMAwEAAgADAAAAEL/P/8QAFhEBAQEAAAAAAAAAAAAAAAAAAQAR/9oACAEDAQE/ENSDCAv/xAAWEQEBAQAAAAAAAAAAAAAAAAABACH/2gAIAQIBAT8QANIVUv/EAB0QAQADAAEFAAAAAAAAAAAAAAEAESExQZGxwdH/2gAIAQEAAT8QToOW0zvF6x119IiVEYrOkMlrkcfEVsC6FEGldXBPk//Z","aspectRatio":1.3793103448275863,"src":"/static/ccacd62b2cb75489034f561354f95cc2/f422e/test.jpg","srcSet":"/static/ccacd62b2cb75489034f561354f95cc2/40426/test.jpg 240w,\n/static/ccacd62b2cb75489034f561354f95cc2/9104c/test.jpg 480w,\n/static/ccacd62b2cb75489034f561354f95cc2/f422e/test.jpg 640w","sizes":"(max-width: 640px) 100vw, 640px"}}}}}},"pageContext":{"slug":"/in-memory-database-tests-with-querydsl/"}}}